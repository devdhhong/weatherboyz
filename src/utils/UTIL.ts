import moment from "moment";
import * as CONST from "@/utils/CONST";
import axios from "axios";

//ë¡œì»¬ìŠ¤í† ë¦¬ì§€ GET
const getLocalStorageItem = function(key: string): string {
  const value = localStorage.getItem(key);
  return value !== null ? value : "";
}

//ë¡œì»¬ìŠ¤í† ë¦¬ì§€ SET
const setLocalStorageItem = function(key: string, value: any) {
  if(typeof value == "object"){
    localStorage.setItem(key, JSON.stringify(value) || ""); 
  }
  else{
    localStorage.setItem(key, value || ""); 
  }
}

// ë‚ ì”¨ ì•„ì´ì½˜ ì´ë¯¸ì§€ ê²½ë¡œ ì¡°íšŒ
const getWeatherIcon = function () {
  const weatherNow = JSON.parse(getLocalStorageItem("weatherNow"));
  const sunrise = Number("0600"); //ì¼ì¶œì‹œê°„
  const sunset = Number("1800"); //ì¼ëª°ì‹œê°„
  const HHmm = Number(moment().format("HHmm")); //í˜„ì¬ì‹œê°„
  
  let url = ""; //ì•„ì´ì½˜ ì´ë¯¸ì§€ ê²½ë¡œ

  const precipType = weatherNow.precipType;
  const skyCondition = weatherNow.skyCondition;

  //ë¹„
  if(precipType == '1'){
    url = "rainy_normal";
  }
  // ëˆˆë¹„
  else if(precipType == '2'){
    url = "rainy_normal";
  }
  // ëˆˆ
  else if(precipType == '3'){
    url = "snowy_normal";
  }
  // ì†Œë‚˜ê¸°
  else if(precipType == '4'){
    url = "rainy_normal";
  }
  // ë§‘ìŒ
  else if(skyCondition == '1'){
    //ë°¤
    if(HHmm > (sunset + 100) || HHmm < (sunrise - 100)){
      url = "sunny_night";
    }
    //ì¼ì¶œ
    else if(HHmm > (sunrise - 100) && HHmm < (sunrise + 100)){
      url = "sunny_sunrise";
    }
    //ì¼ëª°
    else if(HHmm > (sunset - 100) && HHmm < (sunset + 100)){
      url = "sunny_sunset";
    }
    //ë‚®
    else {
      url = "sunny_day";
    }
  }
  else {
    url = "cloudy";
  }

  return "/images/WEATHER/"+ url + ".png";
};

//ë¯¸ì„¸ë¨¼ì§€ ìƒíƒœ ì¡°íšŒ 
const getAirQualityStatus = function (degree1: number, degree2: number) {
  let pm10 = ""; //ë¯¸ì„¸ë¨¼ì§€
  let pm2_5 = ""; //ì´ˆë¯¸ì„¸ë¨¼ì§€

  //ëŒ€í•œë¯¼êµ­ ê¸°ì¤€
  if (degree1 <= 30) { pm10 = "ì¢‹ìŒ"; }
  else if (degree1 <= 80) { pm10 = "ë³´í†µ"; }
  else if (degree1 <= 150) { pm10 = "ë‚˜ì¨"; }
  else { pm10 = "ë§¤ìš°ë‚˜ì¨"; }

  if (degree2 <= 15) { pm2_5 = "ì¢‹ìŒ"; }
  else if (degree2 <= 35) { pm2_5 = "ë³´í†µ"; }
  else if (degree2 <= 75) { pm2_5 = "ë‚˜ì¨"; }
  else { pm2_5 = "ë§¤ìš°ë‚˜ì¨"; }

  return [pm10, pm2_5];
};

//ë©”ì¸í™”ë©´ ë©”ì„¸ì§€ ì¡°íšŒ
const getMainMsg = function () {
  let msg = "";
  const MMDD = moment().format("MMDD");
  const hhmm = moment().format("hhmm");
  // const hhmm24 = moment().format("HHmm");

  const birthday = ["1104", "0530", "0808", "0917", "0115", "0223", "0426", "1105", "0412", "1222", "1206", "0403"];
  const weather = JSON.parse(getLocalStorageItem("weather"));
  const airQuality = JSON.parse(getLocalStorageItem("airQuality"));

  //í‰ê· ëŸ‰
  const rain_6hours = (weather.hourly.rain.slice(0, 6).reduce((acc: number, num: number) => acc + num, 0)) / 6;
  const showers_6hours = (weather.hourly.showers.slice(0, 6).reduce((acc: number, num: number) => acc + num, 0)) / 6;
  const snowfall_6hours = (weather.hourly.snowfall.slice(0, 6).reduce((acc: number, num: number) => acc + num, 0)) / 6;
  const temp_6hours = (weather.hourly.temperature.slice(0, 6).reduce((acc: number, num: number) => acc + num, 0)) / 6;

  const pm10 = airQuality.current.pm10;
  const pm2_5 = airQuality.current.pm2_5;

  //ë‚ ì§œ ê´€ë ¨
  //ì‹œê°„
  if (birthday.indexOf(hhmm) > -1) {
    if (hhmm == "1104") {
      msg = "ğŸ¶ ìƒì—°ì‹œ ğŸ¶";
    }
    else if (hhmm == "0530") {
      msg = "ğŸ ì œì´ì½¥ì‹œ ğŸ";
    }
    else if (hhmm == "0808") {
      msg = "ğŸ ì˜í›ˆì‹œ ğŸ";
    }
    else if (hhmm == "0917") {
      msg = "ğŸ í˜„ì¬ì‹œ ğŸ";
    }
    else if (hhmm == "0115") {
      msg = "ğŸ± ì£¼ì—°ì‹œ ğŸ±";
    }
    else if (hhmm == "0223") {
      msg = "ğŸŒ™ ì¼€ë¹ˆì‹œ ğŸŒ™";
    }
    else if (hhmm == "0426") {
      msg = "ğŸ§ ì°¨ë‹ˆì‹œ ğŸ§";
    }
    else if (hhmm == "1105") {
      msg = "ğŸ¿ï¸ ì°½ë¯¼ì‹œ ğŸ¿ï¸";
    }
    else if (hhmm == "0412") {
      msg = "â˜€ï¸ ì„ ìš°ì‹œ â˜€ï¸";
    }
    else if (hhmm == "1222") {
      msg = "ğŸ¦„ ì˜ì¬ì‹œ ğŸ¦„";
    }
  }
  //ìƒì¼
  else if (birthday.indexOf(MMDD) > -1) {
    if (MMDD == "1104") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ìƒì—° BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0530") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì œì´ì½¥ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0808") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì˜í›ˆ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0917") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY í˜„ì¬ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0115") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì£¼ì—° BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0223") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì¼€ë¹ˆ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0426") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ë‰´ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "1105") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY í BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0412") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì„ ìš° BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "1222") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ì—ë¦­ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "1206") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ë”ë³´ì´ì¦ˆ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
    else if (MMDD == "0403") {
      msg = "ğŸ‰ ğŸ‚ ğŸ¥³ HAPPY ë”ë¹„ BIRTHDAY ğŸ¥³ ğŸ‚ ğŸ‰";
    }
  }
  //ì •ê¸° ì´ë²¤íŠ¸
  else if (MMDD == "0101") {
    msg = "Happy New Year ğŸ§§";
  }
  else if (MMDD == "1225") {
    msg = "Merry Christmas ğŸ„ ğŸ…ğŸ» â›„ï¸";
  }
  //ë‚ ì”¨ ê´€ë ¨
  else if (rain_6hours || showers_6hours) {
    msg = "â˜”ï¸ ë”ëŸ¬ë¶„ ìš°ì‚° ì±™ê¸°ì„¸ìš” â˜”ï¸";
  }
  else if (snowfall_6hours) {
    msg = "â„ï¸ ë”ëŸ¬ë¶„ ìš°ì‚° ì±™ê¸°ì„¸ìš” â„ï¸";
  }
  else if (pm10 > 80 || pm2_5 > 35) {
    msg = "ğŸ˜· ë”ëŸ¬ë¶„ ë§ˆìŠ¤í¬ ì±™ê¸°ì„¸ìš” ğŸ˜·";
  }
  else if (temp_6hours > 28) {
    msg = "ğŸŒ€ ë”ëŸ¬ë¶„ ì†í’ê¸° ì±™ê¸°ì„¸ìš” ğŸŒ€";
  }
  else if (temp_6hours > 33) {
    msg = "ğŸ”¥ í­ ì—¼ ì£¼ ì˜ ğŸ”¥";
  }
  else if (temp_6hours < 0) {
    msg = "ğŸ§£ ë”ëŸ¬ë¶„ ëª©ë„ë¦¬ ì±™ê¸°ì„¸ìš” ğŸ§£";
  }
  else if (temp_6hours < -10) {
    msg = "ğŸ¥¶ í•œ íŒŒ ì£¼ ì˜ ğŸ¥¶";
  }
  else if (weather.current.uv_index > 5) {
    msg = " â˜€ï¸ ë”ëŸ¬ë¶„ ì–‘ì‚° ì±™ê¸°ì„¸ìš” â˜€ï¸";
  }
  //ê¸°íƒ€
  else {
		const targetDate = moment("2025-08-08", "YYYY-MM-DD");
		const diffDay = targetDate.diff(moment(), "days");

		if(Number(diffDay) > 0){
			msg = "ğŸ”¥ã€ˆTHE BLAZE WORLD TOUR in SEOUL D-" + diffDay + " ğŸ”¥";
		}
		else if(Number(diffDay) == 0){
			msg = "ğŸ”¥ã€ˆTHE BLAZE WORLD TOUR in SEOUL D-DAY" + diffDay + " ğŸ”¥";
		} 
		else{
			msg = "ğŸ”¥ã€ˆTHE BLAZEã€‰WORLD TOUR in SEOUL D+" + diffDay + " ğŸ”¥";
		}
    // msg = "ğŸ¶ ğŸ ğŸ ğŸ ğŸ± ğŸŒ™ ğŸ§ ğŸ¿ï¸ â˜€ï¸ ğŸ¦„";
  }

  return msg;
};

// ë‚ ì”¨ ë©”ì¸ ì´ë¯¸ì§€ ê²½ë¡œ ì¡°íšŒ
const getWeatherMain = function (code: number, member: string) {
  const theme = getLocalStorageItem("theme") || "";

  // //ë§‘ìŒ
  // if ([0, 1].indexOf(code) > -1) {
  //   status = "CLEAR";
  // }
  // //íë¦¼
  // else if ([2, 3].indexOf(code) > -1) {
  //   status = "CLOUD";
  // }
  // //ì•½í•œ ë¹„
  // else if ([51, 56, 61, 80].indexOf(code) > -1) {
  //   status = "LIGHT_RAIN";
  // }
  // //ë³´í†µ ë¹„
  // else if ([53, 63, 81].indexOf(code) > -1) {
  //   status = "LIGHT_RAIN";
  // }
  // //ê°•í•œ ë¹„
  // else if ([55, 57, 65, 67, 82].indexOf(code) > -1) {
  //   status = "HEAVY_RAIN";
  // }
  // //ê·¸ ì™¸
  // else {
  //   status = "CLOUD";
  // }

  return "/images/THEME/" + theme + "/" + member + ".jpg";
}

// ì—­ì§€ì˜¤ì½”ë”©
const getReverseGeocode = async function () {
	//SDK ë¡œë“œì—¬ë¶€ ì²´í¬
	const waitingLoad = () => {
		return new Promise<void>((resolve) => {
			const isLoaded = function(){
				if(window.kakao && window.kakao.maps){
					resolve();
				}
				else{
					setTimeout(isLoaded, 100);
				}
			}
			isLoaded();
		});
	}
	waitingLoad();

	window.kakao.maps.load(() => {
		const geocoder = new window.kakao.maps.services.Geocoder();
		const lon = getLocalStorageItem('longitude')
		const lat = getLocalStorageItem('latitude');

		geocoder.coord2Address(lon, lat, (result: any, status: any) => {
			if (status === window.kakao.maps.services.Status.OK) {
				//ë„ë¡œëª…ì£¼ì†Œ  
				if(result[0].road_address){
					setLocalStorageItem("address", result[0].road_address); 
				}
				//êµ¬ì£¼ì†Œ
				else{
					setLocalStorageItem("address", result[0].address); 
				}
			} 
			else {
				//ì‹¤íŒ¨í•  ê²½ìš° ê°€ë°ì´í„° ë…¸ì¶œ
				const fakeData = {
					"address_name": "",
					"region_1depth_name": "",
					"region_2depth_name": "ìœ„ì¹˜ì¡°íšŒ ì‹¤íŒ¨",
					"region_3depth_name": "",
					"road_name": "",
					"underground_yn": "",
					"main_building_no": "",
					"sub_building_no": "",
					"building_name": "",
					"zone_no": ""
				}
				setLocalStorageItem("address", fakeData); 
			}
		});
	});
};

// ì‹¤ì‹œê°„ ë‚ ì”¨ì •ë³´ ì¡°íšŒ
const getWeatherNow = async function () {
  const { base_date, base_time } = getKmaBaseDateTime();

	// ì„œìš¸ ê²©ì ì¢Œí‘œ
  const nx = 60;
  const ny = 127;

  //ì´ˆë‹¨ê¸°ì‹¤í™©ì¡°íšŒ (ê¸°ì˜¨, ìŠµë„ ì¡°íšŒìš©)
  let url = `${CONST.GODATA_WEATHER_URL}`;
  url += `?serviceKey=${import.meta.env.VITE_GODATA_API_KEY}`;
  url += `&pageNo=1&numOfRows=10&dataType=JSON`;
  url += `&base_date=${base_date}`;
  url += `&base_time=${base_time}`;
  url += `&nx=${nx}`;
  url += `&ny=${ny}`;

	const res = await axios.get(url);
  const items = res.data.response.body.items.item;

	const data = {
		temperature: "", 
		humidity: "",
		precipType: "",
		precipProbability: "",
		skyCondition: "",
		windSpeed: "",
		minumumTemp: "",
		maximumTemp: "",
	};

  data.temperature = items.find((i: any) => i.category === 'TMP')?.fcstValue; //ê¸°ì˜¨
  data.humidity = items.find((i: any) => i.category === 'REH')?.fcstValue; //ìŠµë„
  data.precipType = items.find((i: any) => i.category === 'PTY')?.fcstValue; //ê°•ìˆ˜ í˜•íƒœ (ë¹„/ëˆˆ ë“±)
  data.precipProbability = items.find((i: any) => i.category === 'POP')?.fcstValue; //ê°•ìˆ˜ í™•ë¥  (%)
  data.skyCondition = items.find((i: any) => i.category === 'SKY')?.fcstValue; //í•˜ëŠ˜ ìƒíƒœ (ë§‘ìŒ/íë¦¼ ë“±)
  data.windSpeed = items.find((i: any) => i.category === 'WSD')?.fcstValue; //	í’ì† (m/s)
  data.minumumTemp = items.find((i: any) => i.category === 'TMN')?.fcstValue; //	ì¼ ìµœì €ê¸°ì˜¨
  data.maximumTemp = items.find((i: any) => i.category === 'TMX')?.fcstValue; // ì¼ ìµœëŒ€ê¸°ì˜¨

  console.log(data);
	//ë°ì´í„° ì €ì¥
	setLocalStorageItem("weatherNow", data); 
	console.log("âœ… ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì™„ë£Œ!");
};

// ëŒ€ê¸°ì •ë³´ ì¡°íšŒ
const getAirQuality = async function () {
  try {
    // axios.get()ëŠ” Promiseë¥¼ ë°˜í™˜
    const response = await axios.get(`${CONST.NOW_AIRQUALITY_URL}`, {
      params: {
        latitude: getLocalStorageItem('latitude'),
        longitude: getLocalStorageItem('longitude'),
        current: "pm10,pm2_5,uv_index"
      }
    });

		//ë°ì´í„° ì €ì¥
    setLocalStorageItem("airQuality", response.data); // ì„±ê³µì ìœ¼ë¡œ ë°›ì•„ì˜¨ ë°ì´í„° ì €ì¥

		console.log("âœ… ëŒ€ê¸° ì •ë³´ ì¡°íšŒ ì™„ë£Œ!");
  } 
	catch (error) {
    console.error('[ERROR]', error);
    throw error; 
  }
};

// ìŠ¤í¬í‹°íŒŒì´ í† í° ë°œê¸‰
const getSpotifyToken = async function () {
	const now = Number(moment().format("YYYYMMDDHHmm"));
	const token_expires_in = Number(getLocalStorageItem('token_expires_in') || "");
	const access_token = Number(getLocalStorageItem('access_token') || "");

	//ì €ì¥ëœ í† í°ì´ ì—†ê±°ë‚˜ ë§Œë£Œëœ ê²½ìš°ì—ë§Œ, ì¬ë°œê¸‰
	//50ë¶„ì— í•œë²ˆ ë°œê¸‰í•˜ë„ë¡í•´ì„œ ë¶ˆí•„ìš”í•œ í˜¸ì¶œ ë°©ì§€
  if(access_token && token_expires_in && (token_expires_in > now)){
		return;
	}

  const result = await fetch(`${CONST.SPOTIFY_TOKEN_URL}`, {
    method: "POST",
    headers: {
      Authorization:
        "Basic " + btoa(`${import.meta.env.VITE_SPOTIFY_CLIENT_ID}:${import.meta.env.VITE_SPOTIFY_CLIENT_SECRET}`),
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "grant_type=client_credentials",
  });

  const data = await result.json();
	
	//í† ê·¼ê°’ì€ 1ì‹œê°„ ë™ì•ˆë§Œ ìœ íš¨
	setLocalStorageItem("token_expires_in", moment().add(50, "minutes").format("YYYYMMDDHHmm"));
	setLocalStorageItem("access_token", data.access_token); 

	console.log("âœ… ìŠ¤í¬í‹°íŒŒì´ í† ê·¼ ë°œê¸‰ ì™„ë£Œ!");
};

const getKmaBaseDateTime = function() {
  const now = new Date();

  // ê¸°ìƒì²­ base_time ëª©ë¡ (ì •í•´ì§„ ê°’ë§Œ ê°€ëŠ¥)
  const baseTimes = ["0200", "0500", "0800", "1100", "1400", "1700", "2000", "2300"];

  // í˜„ì¬ ì‹œê°ì„ HHMM í˜•ì‹ìœ¼ë¡œ
  const currentHHMM = now.getHours().toString().padStart(2, '0') + 
    now.getMinutes().toString().padStart(2, '0');

  // base_time ì¤‘ í˜„ì¬ ì‹œê°ë³´ë‹¤ ì‘ì€ ê°€ì¥ ë§ˆì§€ë§‰ ê°’ ì°¾ê¸°
  let selectedTime = baseTimes.findLast(bt => bt <= currentHHMM);

  // ìì • ì´í›„(00:00~01:59)ì—” base_time = "2300", base_dateëŠ” ì „ë‚ ë¡œ
  if (!selectedTime) {
    selectedTime = "2300";
    now.setDate(now.getDate() - 1); // ì „ë‚ ë¡œ ì´ë™
  }

  // base_date: YYYYMMDD í˜•ì‹
  const baseDate = now.getFullYear().toString() +
    (now.getMonth() + 1).toString().padStart(2, '0') +
    now.getDate().toString().padStart(2, '0');

  return {
    base_date: baseDate,
    base_time: selectedTime
  };
}

export {
  getLocalStorageItem,
  setLocalStorageItem,
  getWeatherIcon,
  getAirQualityStatus,
  getMainMsg,
  getWeatherMain,
  getReverseGeocode,
  getWeatherNow,
  getAirQuality,
	getSpotifyToken,
  getKmaBaseDateTime
};
